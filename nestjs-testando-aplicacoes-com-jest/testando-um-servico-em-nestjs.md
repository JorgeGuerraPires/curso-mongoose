---
description: 'Nesta p√°gina, vamos testar um servi√ßo (service) em NestJS.'
---

# Testando um servi√ßo em NestJS

![Frase atribu&#xED;da a Bruce Lee ](../.gitbook/assets/bruce-lee.jpg)

√â muito f√°cil justificar um ponto de vista errado com frases de efeito, especialmente se for de algu√©m famoso. Como diz Jim Tamm no contexto de ser defensivo, em [Ted talk](https://www.youtube.com/watch?v=vjSTNv4gyMM): "seria como colocar creme em bosta de cachorro" \[tradu√ß√£o livre, adaptado\]üòÇ

O motivo que estou falando isso √© porque essa frase geralmente atribu√≠da a Bruce Lee diz bem o que estou por ensinar: prefiro usar a mesma ferramenta v√°rias vezes, como j√° usamos o mock sem spy, vamos usar sem spy novamente. Estava preparando essa aula, quando vi que o c√≥digo original que usava estava usando spy sem necessidade, pelo menos consegui resolver o problema sem spy. Caso voc√™ queira usar spy, n√£o h√° nada de errado nisso, pode ser at√© mesmo um exerc√≠cio. Contudo, n√£o vamos usar spy! Prefiro ser temido por treinar o mesmo chute 1.000 vezes! üòÅ

{% hint style="info" %}
Criei uma se√ß√£o sobe spy [aqui](../um-curso-sintetico-em-jest/spyon.md).
{% endhint %}

{% hint style="info" %}
C√≥digos [aqui](https://github.com/JorgeGuerraPires/curso-mongoose/tree/mock_service_nestjs).
{% endhint %}

Objetivo: testar, mocando, o servi√ßo abaixo.



```typescript
  //dog.service.ts
  //Testando....
  findAll(): Promise<Dog[]> {
    return this.catModel.find().exec();
  }

```

{% hint style="info" %}
IMP. como ver no nosso c√≥digo no GitHub, n√£o tem nenhuma conex√£o com o Mongo. Gostaria de aprender a conectar ao Mongo do NestJS. [Aqui](https://github.com/JorgeGuerraPires/nest/tree/master/sample/06-mongoose) um exemplo oficialüòéüòéüòé
{% endhint %}

```typescript
  //--------------------------------------------------------
  //Come√ßa os testes
  it('should return all dogs', async () => {
    const dogs = await service.findAll();
    expect(dogs).toEqual(canil);
  });
  //---------------------------------------------------------

```

o mock foi colocado no `beforeEach`

```typescript
  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [DogService,
        {
          provide: getModelToken('Dog'),
          useValue:
          {
            find: jest.fn().mockReturnValue({
              exec: jest.fn().mockResolvedValueOnce(canil)
            } as any)
            //um cuidado se deve tomar aqui, estamos mocando n√£o o m√©todo do service, 
            //mas sim o m√©tdo chamado pelo 
            //m√©todo do servico, ou seja, o m√©todo em cadeia do Mongoose
          }
        }],
    }).compile();

```

{% hint style="info" %}
O original usava spy+mock. Ver [aqui](https://github.com/JorgeGuerraPires/testing-nestjs/blob/master/apps/mongo-sample/src/cat/cat.service.spec.ts).
{% endhint %}



